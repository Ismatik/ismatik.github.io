import React, { useState, useEffect, useCallback } from 'react';

// --- Constants and Utility Functions ---

// The GitHub API endpoint for the user profile
const GITHUB_PROFILE_URL = "https://api.github.com/users/Ismatik";
const GITHUB_REPOS_URL = "https://api.github.com/users/Ismatik/repos";

// Mocked data for structure, to be replaced by API fetch
const initialProfileState = {
    username: 'Ismatik',
    name: 'Developer Portfolio',
    // UPDATED: Initial bio placeholder
    bio: 'Developer at Koinoti Nav',
    avatar_url: 'https://placehold.co/100x100/4F46E5/FFFFFF?text=Loading',
    html_url: 'https://github.com/Ismatik',
};

// UPDATED: Use tajmotors and mehnat for initial state placeholders
const initialProjectsState = [
    { name: 'tajmotors', description: 'Loading...', language: 'JS', stars: 0, url: '#' },
    { name: 'mehnat', description: 'Loading...', language: 'C++/Python', stars: 0, url: '#' },
];

/**
 * Fetches data from a given API URL using exponential backoff.
 * @param {string} url - The URL to fetch.
 * @returns {Promise<any>} - The parsed JSON data.
 */
const fetchWithBackoff = async (url, retries = 3) => {
    const apiKey = ""; // Canvas environment handles the key
    const apiUrl = `${url}?key=${apiKey}`;

    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                // If the response is not ok, throw to trigger a retry or final error
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Fetch attempt ${i + 1} failed for ${url}:`, error);
            if (i < retries - 1) {
                // Exponential backoff: wait 2^i seconds
                const delay = Math.pow(2, i) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                // Last attempt failed, throw the final error
                throw new Error(`Failed to fetch ${url} after ${retries} attempts.`);
            }
        }
    }
};

// --- Project Card Component ---

const ProjectCard = ({ project, index }) => (
    <a 
        href={project.html_url} 
        target="_blank" 
        rel="noopener noreferrer" 
        className={`
            group block p-6 md:p-10 border-b border-r border-indigo-200 
            hover:bg-indigo-50 transition duration-300 ease-out 
            transform hover:scale-[1.01] cursor-pointer
        `}
        style={{ transitionDelay: `${index * 50}ms` }}
    >
        <div className="flex justify-between items-start mb-4">
            <h3 className="text-3xl md:text-5xl font-extrabold text-indigo-700 
                group-hover:text-indigo-900 transition duration-300">
                {project.name}
            </h3>
            <span className="text-sm font-mono text-gray-500 bg-indigo-100 p-1 px-3 rounded-full">
                {project.language}
            </span>
        </div>
        <p className="text-lg text-gray-700 mb-4">
            {project.description || 'No description provided.'}
        </p>
        <div className="flex items-center text-sm font-semibold text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.243.588 1.81l-2.817 2.042a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.042a1 1 0 00-1.175 0l-2.817 2.042c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.022 8.729c-.783-.567-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
            {project.stargazers_count} Stars
        </div>
    </a>
);

// --- Main Application Component ---

const App = () => {
    const [profile, setProfile] = useState(initialProfileState);
    const [projects, setProjects] = useState(initialProjectsState);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [currentPage, setCurrentPage] = useState('HOME');

    const fetchGitHubData = useCallback(async () => {
        try {
            setLoading(true);
            setError(null);

            // Fetch Profile Data
            const profileResponse = await fetchWithBackoff(GITHUB_PROFILE_URL);
            setProfile(prev => ({
                ...prev,
                username: profileResponse.login,
                name: profileResponse.name || profileResponse.login,
                // UPDATED: Fallback bio text
                bio: profileResponse.bio || "Developer at Koinoti Nav.",
                avatar_url: profileResponse.avatar_url,
                html_url: profileResponse.html_url,
            }));

            // Fetch Repositories
            const reposResponse = await fetchWithBackoff(GITHUB_REPOS_URL);
            
            // UPDATED: Filter for the newly requested featured projects (tajmotors and mehnat)
            const featuredRepos = reposResponse
                .filter(repo => repo.name === 'tajmotors' || repo.name === 'mehnat')
                .map(repo => ({
                    name: repo.name,
                    description: repo.description,
                    language: repo.language || 'Multiple',
                    stargazers_count: repo.stargazers_count,
                    html_url: repo.html_url,
                }));

            // If the filter didn't find both (e.g., they are in an organization), use the initial mock structure as fallback
            if (featuredRepos.length < initialProjectsState.length) {
                // If API didn't return exactly the expected repos, use a simple fallback structure
                setProjects([
                    ...initialProjectsState.map((initial, index) => {
                        const found = featuredRepos.find(r => r.name === initial.name);
                        return found || initial;
                    }),
                    ...featuredRepos.filter(repo => !initialProjectsState.some(p => p.name === repo.name))
                ]);
            } else {
                 setProjects(featuredRepos);
            }
            
        } catch (err) {
            console.error('Final data fetch failed:', err);
            setError("Failed to load GitHub data. Displaying fallback content.");
            setProjects(initialProjectsState); // Display static placeholders on failure
        } finally {
            setLoading(false);
        }
    }, []);

    useEffect(() => {
        // Set Firebase Log Level to Debug (Required for Firestore/Auth debugging)
        if (typeof setLogLevel !== 'undefined') {
            try { setLogLevel('Debug'); } catch(e) {}
        }
        
        fetchGitHubData();
    }, [fetchGitHubData]);

    const renderContent = () => {
        if (currentPage === 'HOME') {
            return (
                <div className="flex flex-col justify-center items-start h-full p-8 md:p-16">
                    <p className="text-xl md:text-2xl font-light text-gray-500 mb-4 tracking-widest uppercase">
                        Hi, I'm
                    </p>
                    {/* Main title text */}
                    <h2 className="text-6xl md:text-8xl lg:text-9xl font-extrabold text-gray-800 leading-none">
                        ISMATULLO'S
                        <br />
                        <span className="text-indigo-600">PROFILE.</span>
                    </h2>
                    {/* The descriptive bio text */}
                    <p className="mt-8 text-xl md:text-3xl max-w-2xl font-light text-gray-600">
                        {profile.bio}
                    </p>
                    <div className="mt-12 flex space-x-4">
                        {/* Primary button now links to Telegram bot */}
                        <a
                            href="https://t.me/ismat_assistant_bot"
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-xl font-semibold px-8 py-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition duration-300 shadow-xl"
                        >
                            Continue to Assistant (Telegram)
                        </a>
                        {/* Secondary button links to GitHub Profile */}
                        <a
                            href={profile.html_url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-xl font-semibold px-8 py-3 border border-indigo-600 text-indigo-600 rounded-full hover:bg-indigo-50 transition duration-300"
                        >
                            GitHub Profile
                        </a>
                    </div>
                </div>
            );
        }

        if (currentPage === 'PROJECTS') {
            return (
                <div className="h-full overflow-y-auto p-8 md:p-16">
                    <h2 className="text-5xl md:text-7xl font-extrabold text-gray-800 mb-10 border-b-4 border-indigo-200 pb-4">
                        Featured Projects
                    </h2>
                    
                    {loading && <p className="text-center text-xl text-indigo-500 py-10">Loading projects...</p>}
                    {error && <p className="text-center text-red-500 py-10">{error}</p>}

                    <div className="grid grid-cols-1 divide-y divide-indigo-200">
                        {projects.map((project, index) => (
                            <ProjectCard key={project.name} project={project} index={index} />
                        ))}
                    </div>

                    <div className="mt-12 text-center">
                        <a
                            href={profile.html_url + '?tab=repositories'}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-xl font-semibold px-8 py-3 bg-gray-700 text-white rounded-full hover:bg-gray-800 transition duration-300 shadow-xl"
                        >
                            See All Repositories
                        </a>
                    </div>
                </div>
            );
        }
        return null;
    };

    return (
        <div className="min-h-screen bg-white relative overflow-hidden">
            
            {/* Background Shape for Visual Interest */}
            <div className="absolute top-0 right-0 w-3/5 h-full bg-indigo-50 opacity-40 transform rotate-[-3deg] origin-top-left -translate-y-1/4 -translate-x-1/4 z-0 pointer-events-none"></div>

            {/* Fixed Navigation/Header */}
            <header className="fixed top-0 left-0 w-full z-20 flex justify-between items-center p-8 backdrop-blur-sm bg-white/70 shadow-sm">
                <div 
                    className="text-2xl font-extrabold cursor-pointer text-indigo-700 hover:text-indigo-900 transition duration-300"
                    onClick={() => setCurrentPage('HOME')}
                >
                    Ismatik
                </div>
                <nav className="space-x-4 flex">
                    <button
                        onClick={() => setCurrentPage('HOME')}
                        className={`text-lg font-medium transition duration-300 
                            ${currentPage === 'HOME' ? 'text-indigo-600 font-bold border-b-2 border-indigo-600' : 'text-gray-600 hover:text-indigo-600'}`}
                    >
                        Home
                    </button>
                    <button
                        onClick={() => setCurrentPage('PROJECTS')}
                        className={`text-lg font-medium transition duration-300 
                            ${currentPage === 'PROJECTS' ? 'text-indigo-600 font-bold border-b-2 border-indigo-600' : 'text-gray-600 hover:text-indigo-600'}`}
                    >
                        Projects
                    </button>
                </nav>
            </header>

            {/* Main Content Area */}
            <main className="relative z-10 pt-24 min-h-screen transition-opacity duration-700 ease-in-out">
                {renderContent()}
            </main>

            {/* Fixed Footer/Contact Link */}
            <footer className="fixed bottom-0 left-0 w-full z-20 p-8 flex justify-end">
                <a 
                    href={`mailto:${profile.username}@example.com`} 
                    className="text-lg font-medium text-gray-500 hover:text-indigo-600 transition duration-300"
                >
                    CONTACT
                </a>
            </footer>

        </div>
    );
};

export default App;
